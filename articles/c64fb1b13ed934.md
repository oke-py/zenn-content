---
title: "docker/build-push-actionã§ãƒãƒ«ãƒãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã‚¿ã‚°ã‚’æ‰“ã¤"
emoji: "ğŸ¤–"
type: "tech"
topics: ["docker", "githubactions", "mac"]
published: true
---

## ã¯ã˜ã‚ã«

ç§ã¯ã€GitHubã®contributionæ•°ã‚’å¹´ã¾ãŸã¯æœˆå˜ä½ã§é›†è¨ˆã™ã‚‹ãƒ„ãƒ¼ãƒ«ã‚’[Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã—ã¦å…¬é–‹](https://hub.docker.com/repository/docker/okepy/contribution)ã—ã¦ã„ã¾ã™ã€‚

M1 Macã‚’ä½¿ã†ã‚ˆã†ã«ãªã‚Šï¼ˆé•·ã‚‰ãæ”¾ç½®ã—ã¦ã„ã¾ã—ãŸãŒï¼‰ARMå¯¾å¿œã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

- linux/amd64
- linux/arm64

ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ãƒãƒ«ãƒãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚¤ãƒ¡ãƒ¼ã‚¸ã®å…¬é–‹ã‚’è©¦ã¿ã¾ã—ãŸã€‚å˜ç´”ã«`docker tag`ã¨`docker push`ã‚’ã™ã‚‹ã¨ã€`linux/amd64`ã¨`linux/arm64`ã®ç‰‡æ–¹ã®ã¿ã«ã‚¿ã‚°ãŒä»˜ã„ã¦ã—ã¾ã„ã¾ã—ãŸã€‚

`docker/build-push-action`ã‚’åˆ©ç”¨ã—ã¦è§£æ±ºã—ãŸãŸã‚ã€ç´¹ä»‹ã—ã¾ã™ã€‚

## è§£æ±ºã—ãŸèª²é¡Œ

`docker pull`ã‚„`docker run`ã‚’å®Ÿè¡Œã™ã‚‹ç’°å¢ƒã«ã‚ã‚ã›ã¦é©åˆ‡ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚Docker Hubã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«`OS/ARCH`ã‚’é¸æŠã§ãã¾ã™ã€‚

![multi-platform-image-on-docker-hub](https://storage.googleapis.com/zenn-user-upload/9b0278b371a9-20220430.png)

## GitHub Actionsã«ãŠã‘ã‚‹è§£æ±ºæ–¹æ³•

Dockerå…¬å¼ã®GitHub Actionsã‚’åˆ©ç”¨ã™ã‚‹ã¨ç°¡å˜ã§ã™ã€‚

1. `docker/setup-qemu-action`ã‚’å®Ÿè¡Œã™ã‚‹
2. `docker/setup-buildx-action`ã‚’å®Ÿè¡Œã™ã‚‹
3. `platform`ã¨`tag`ã‚’æŒ‡å®šã—ã¦`docker/build-push-action`ã‚’å®Ÿè¡Œã™ã‚‹

`main`ãƒ–ãƒ©ãƒ³ãƒã«å¯¾ã™ã‚‹pushã‚’ãƒˆãƒªã‚¬ãƒ¼ã¨ã—ã¦`docker push [options] $REPOSITORY:latest`ã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã¯ã“ã¡ã‚‰ã§ã™ã€‚

https://github.com/oke-py/contributions/blob/855aa37938dd92bb87485bb32c6b0b7de2546f7d/.github/workflows/docker.yml

GitHubãƒªãƒã‚¸ãƒˆãƒªã§ã‚¿ã‚°ã‚’ä½œæˆã—ãŸã¨ãã«`docker push [options] $REPOSITORY:$TAG`ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

https://github.com/oke-py/contributions/blob/855aa37938dd92bb87485bb32c6b0b7de2546f7d/.github/workflows/docker-tag.yml

## å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ã®å†ç¾

ã‚„ã‚ŠãŸã„ã“ã¨ã¯ã§ãã¾ã—ãŸãŒã€ã‚‚ã†å°‘ã—è¿½ã„ã‹ã‘ã¦ã¿ã¾ã™ã€‚ã©ã®ã‚ˆã†ãª`docker`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ã®ã‹ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚“ã§è§£ãæ˜ã‹ã—ã¾ã™ã€‚

`main.ts`ã‚’èª­ã‚€ã¨ã€`docker`ã‚³ãƒãƒ³ãƒ‰ã®å¼•æ•°ã«`args`å¤‰æ•°ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã¨ã‚ã‹ã‚Šã¾ã™ã€‚
https://github.com/docker/build-push-action/blob/ba317382dcde9f7deb318467fc6cd7230d8b1714/src/main.ts#L25-L34

ã“ã®`args`ã¯`context.ts`ã®`getArgs`é–¢æ•°ã®è¿”ã‚Šå€¤ã§ã™ã€‚
https://github.com/docker/build-push-action/blob/ba317382dcde9f7deb318467fc6cd7230d8b1714/src/context.ts#L101-L109

`getBuildArgs`é–¢æ•°ã¨`getBuildArgs`é–¢æ•°ã¯ã€è¨­å®šå€¤ã‚’ã‚‚ã¨ã«ã²ãŸã™ã‚‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚é•·ã„ã®ã§æŠœç²‹ã—ã¾ã™ã€‚

https://github.com/docker/build-push-action/blob/ba317382dcde9f7deb318467fc6cd7230d8b1714/src/context.ts#L111-L115

å‰è¿°ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’ã‚‚ã¨ã«ã—ãŸã€ã‚³ãƒãƒ³ãƒ‰ã®å†ç¾çµæœã¯ã“ã¡ã‚‰ã§ã™ã€‚å¯èª­æ€§ã®ãŸã‚é©å®œæ”¹è¡Œã—ã¾ã™ã€‚

```sh
docker buildx build \
  --platform linux/amd64,linux/arm64 \
  --tag okepy/contribution:latest \
  --push \
  .
```

ã¸ãƒ¼ã€ã“ã†ã™ã‚‹ã®ã§ã™ã­ã€‚çŸ¥ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚

## å†ç¾ã—ãŸã‚³ãƒãƒ³ãƒ‰ã‚’M1 Macã§å®Ÿè¡Œ

```
[+] Building 0.0s (0/0)                                                                                                                                       
error: multiple platforms feature is currently not supported for docker driver. Please switch to a different driver (eg. "docker buildx create --use")
```

ã‚€ã‚€ã€ã‚¨ãƒ©ãƒ¼ã¨ãªã‚Šã¾ã—ãŸã€‚ä»¥ä¸‹ã®Issueã‚’èª­ã‚€ã¨ã€è§£æ±ºæ–¹æ³•ã«æŒ™ã’ãŸ

- `docker/setup-qemu-action`
- `docker/setup-buildx-action`

ãŒå¿…è¦ã¨ãªã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ï¼ˆç§ã¯ã“ã“ã§æº€è¶³ã—ã¦ã—ã¾ã£ãŸãŸã‚ã€è©¦ã—ã¦ã„ã¾ã›ã‚“ï¼‰ã€‚

https://github.com/docker/build-push-action/issues/302

## ãŠã‚ã‚Šã«

Dockerå…¬å¼ã®GitHub Actionsã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã§ã€ç°¡å˜ã«ãƒãƒ«ãƒãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆã§ãã¾ã—ãŸã€‚

ãƒãƒ«ãƒãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨è¨€ãˆã°ã€[Cybozu Productivity News #2 - 2022.04.28](https://cybozu.github.io/productivity-news/posts/2022/04-28/)ã§ãƒ“ãƒ«ãƒ‰é«˜é€ŸåŒ–ã®æ–¹æ³•ãŒç´¹ä»‹ã•ã‚Œã¾ã—ãŸã€‚`docker manifest` çŸ¥ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãªãŠã€ã“ã¡ã‚‰ã®è¨˜äº‹ã§ã¯ãƒãƒ«ãƒã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å¯¾å¿œã‚¤ãƒ¡ãƒ¼ã‚¸ã¨è¡¨ç¾ã•ã‚Œã¦ã„ã¾ã™ã€‚

https://poyo.hatenablog.jp/entry/2021/09/25/225329

## å‚è€ƒ

https://github.com/docker/build-push-action
