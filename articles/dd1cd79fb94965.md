---
title: "å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚ã‚‹è¤‡æ•°YAMLãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã†ã¡ã€1ã¤ã‚’yqã§æŠ½å‡ºã™ã‚‹"
emoji: "ğŸ—‚"
type: "tech"
topics: ["yaml", "kubernetes"]
published: true
published_at: 2022-12-10 13:00
---
## æ¦‚è¦

`kustomize build`ã®å‡ºåŠ›ãªã©ã€å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã«è¤‡æ•°ã®YAMLãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¨˜è¿°ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ãã®YAMLãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®1ã¤ã‚’æŠ½å‡ºã—ãŸã„å ´åˆã€`yq`ã‚’åˆ©ç”¨ã§ãã¾ã™ã€‚

ä»¥ä¸‹ã®`example.yaml`ã‚’ä¾‹ã¨ã—ã¦ã€ã‚³ãƒãƒ³ãƒ‰ã¨å®Ÿè¡Œçµæœã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

```yaml:example.yaml
foo: bar
---
hoge: fuga
```

```bash
$ yq '(select(documentIndex == 0) | .)' example.yaml
foo: bar

$ yq '(select(documentIndex == 1) | .)' example.yaml
hoge: fuga
```

## ç’°å¢ƒ

ç­†è€…ã¯ macOS Monterey 12.6.1ï¼ˆApple M1ï¼‰ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
`yq`ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ã“ã¡ã‚‰ã§ã™ã€‚
```bash
$ yq --version
yq (https://github.com/mikefarah/yq/) version v4.30.5
```

## ç›®çš„

[@hhiroshell](https://zenn.dev/hhiroshell)ã•ã‚“ã«èªã‚Šå°½ãã•ã‚Œã¦ã„ã¾ã—ãŸã€‚
@[speakerdeck](7f762ad01c3545e28fd81c09737088b7)

ç­†è€…ã¯`kubectl`ã‚’ç´ ã®ã¾ã¾ä½¿ã‚ãªã„ç’°å¢ƒã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚`kubectl diff`ç›¸å½“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’åˆ©ç”¨ã§ããªã„ã€ã¾ãŸã€kubectl pluginã§è§£æ±ºã§ããªã„ãŸã‚ã€åˆ¥ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’å–ã‚Šã¾ã—ãŸ[^1]ã€‚

ã¾ãšã€å¤‰æ›´å‰ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’é©ç”¨ã—ã¾ã™ã€‚

https://github.com/oke-py/zenn-sample-dd1cd79fb94965/blob/804e9b7e99bba31903b7142b3668185da45a7a9f/before/app.yaml

```bash
kubectl apply -f before/app.yaml
```

ConfigMapGeneratorã«æŒ‡å®šã™ã‚‹å€¤ã‚’ç·¨é›†ã—ã€`kustomize build`ã—ã¾ã™ã€‚ã“ã“ã§ã¯ã€ã‚µãƒ³ãƒ—ãƒ«ãƒªãƒã‚¸ãƒˆãƒªã®ã‚ã‹ã‚Šã‚„ã™ã•ã‚’è€ƒæ…®ã—ã€ãƒ•ã‚¡ã‚¤ãƒ«ä¸€å¼ã‚’`before`ã¨`after`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«é…ç½®ã—ã¦ã„ã¾ã™ã€‚

`after/app.yaml`ã‚’é©ç”¨ã™ã‚‹å‰ã«ã€å·®åˆ†ã‚’ç¢ºèªã—ã¾ã™ã€‚

```bash
diff -upN <(kubectl apply -f after/app.yaml view-last-applied) after/app.yaml
```

å‡ºåŠ›çµæœã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚1è¡Œç›®ã¯stderrã«å‡ºåŠ›ã•ã‚Œã¾ã™ã€‚
ConfigMapã®åå‰ãŒå¤‰æ›´ã•ã‚Œã¦ãŠã‚Šã€æœŸå¾…ã—ãŸçµæœã‚’å¾—ã‚‰ã‚Œã¾ã›ã‚“ã€‚

```diff
Error from server (NotFound): configmaps "example-configmap-1-286h7kfc5k" not found
--- /dev/fd/11  2022-12-10 12:13:10.000000000 +0900
+++ after/app.yaml      2022-12-10 11:51:08.000000000 +0900
@@ -0,0 +1,27 @@
+apiVersion: v1
+data:
+  FOO: baz
+kind: ConfigMap
+metadata:
+  annotations:
+    app: example
+  name: example-configmap-1-286h7kfc5k
+  namespace: default
+---
+apiVersion: v1
+kind: Pod
+metadata:
+  annotations:
+    app: example
+  name: example
+  namespace: default
+spec:
+  containers:
+  - env:
+    - name: FOO
+      valueFrom:
+        configMapKeyRef:
+          key: FOO
+          name: example-configmap-1-286h7kfc5k
+    image: nginx
+    name: nginx
```

è§£æ±ºç­–ã¨ã—ã¦1ã¤ãšã¤æ¯”è¼ƒã™ã‚‹ã“ã¨ã‚’æ€ã„ã¤ãã¾ã—ãŸã€‚ã“ã“ã§ã€æ¦‚è¦ã§ç´¹ä»‹ã—ãŸã‚³ãƒãƒ³ãƒ‰ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

### Podã®å·®åˆ†ã‚’ç¢ºèªã™ã‚‹

```bash:ã‚³ãƒãƒ³ãƒ‰
diff -upN \
  <(kubectl get pod example -o yaml | yq '.metadata.annotations.["kubectl.kubernetes.io/last-applied-configuration"]' | jq | yq -P .) \
  <(yq '(select(documentIndex == 1) | .)' after/app.yaml)
```
```diff:å®Ÿè¡Œçµæœ
--- /dev/fd/11  2022-12-10 12:04:25.000000000 +0900
+++ /dev/fd/14  2022-12-10 12:04:25.000000000 +0900
@@ -12,6 +12,6 @@ spec:
           valueFrom:
             configMapKeyRef:
               key: FOO
-              name: example-configmap-1-59m54fbgh2
+              name: example-configmap-1-286h7kfc5k
       image: nginx
       name: nginx
```

### ConfigMapã®å·®åˆ†ã‚’ç¢ºèªã™ã‚‹

```bash:ã‚³ãƒãƒ³ãƒ‰
CONFIGMAP=$(kubectl get pod example -o jsonpath='{.spec.containers[?(@.name=="nginx")].env[0].valueFrom.configMapKeyRef.name}')
diff -upN \
  <(kubectl get cm $CONFIGMAP -o yaml | yq '.metadata.annotations.["kubectl.kubernetes.io/last-applied-configuration"]' | jq | yq -P .) \
  <(yq '(select(documentIndex == 0) | .)' after/app.yaml)
```
```diff:å®Ÿè¡Œçµæœ
--- /dev/fd/11  2022-12-10 12:10:14.000000000 +0900
+++ /dev/fd/14  2022-12-10 12:10:14.000000000 +0900
@@ -1,9 +1,9 @@
 apiVersion: v1
 data:
-  FOO: bar
+  FOO: baz
 kind: ConfigMap
 metadata:
   annotations:
     app: example
-  name: example-configmap-1-59m54fbgh2
+  name: example-configmap-1-286h7kfc5k
   namespace: default
```

## ãŠã‚ã‚Šã«

`yq`ã‚’åˆ©ç”¨ã—ã¦`kustomize build`ã®å‡ºåŠ›ã‹ã‚‰å¾—ãŸã„æƒ…å ±ã‚’æŠ½å‡ºã§ãã¾ã—ãŸã€‚è€ƒæ¡ˆã—ãŸ`diff`ã‚³ãƒãƒ³ãƒ‰ã¯æŸ”è»Ÿæ€§ã«æ¬ ã‘ã¾ã™ãŒã€ç§ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§ã¯ååˆ†ãªã‚‚ã®ã¨ãªã‚Šã¾ã—ãŸã€‚

## å‚è€ƒ
æœ¬è¨˜äº‹ã§ç´¹ä»‹ã—ãŸã‚³ãƒãƒ³ãƒ‰ã¯ã€ã“ã¡ã‚‰ã®Issueã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚
https://github.com/mikefarah/yq/issues/9

[^1]: æ­£ç¢ºã«ã¯ã€ç´¹ä»‹ã—ãŸã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’è©¦ã—ãŸå¾Œã§[@hhiroshell](https://zenn.dev/hhiroshell)ã•ã‚“ã®ç™ºè¡¨ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’çŸ¥ã‚Šã¾ã—ãŸã€‚
