---
title: "Grafana Helm Chartã®ã¡ã‚‡ã£ã¨ã—ãŸãƒãƒã‚Šã©ã“ã‚"
emoji: "ğŸŒŠ"
type: "tech"
topics: ["grafana"]
published: true
---

## ã¯ã˜ã‚ã«

[CloudNative Days Tokyo 2021](https://event.cloudnativedays.jp/cndt2021)ï¼ˆCNDT2021ï¼‰ã®é…ä¿¡ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«[Grafana Helm Chart](https://github.com/grafana/helm-charts/tree/main/charts/grafana)ã‚’å°å…¥ã—ãŸã¨ãã«ãƒãƒã£ãŸã“ã¨ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

ä»¥ä¸‹ã®ãµã‚Šã‹ãˆã‚Šãƒã‚¨ãƒ ã§äºˆå‘Šã—ã¦ã„ãŸã‚‚ã®ã§ã™ã€‚

> Grafanaãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ä½œã‚‹ã†ãˆã§ãƒãƒã£ãŸã“ã¨ãªã©æŠ€è¡“çš„ãªè©±ã¯å¾Œæ—¥Zennã«æŠ•ç¨¿äºˆå®šã§ã™ã€‚Observability Conferenceã¾ã§å¼•ã£å¼µã‚‹ãƒã‚¿ã§ã‚‚ãªã„ã®ã§ã€‚

https://ngoktanio.hatenablog.com/entry/2021/11/06/163755

## ãƒãƒã‚Šã©ã“ã‚

### Deploymentã®ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒé€²ã¾ãªã„

Grafana Helm Chartã‚’`persistence.enabled = true`ã¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨`grafana`ã¯Deploymentã¨ã—ã¦ä½œæˆã•ã‚Œã€ãã®Deployment Strategyã¯`RollingUpdate`ã§ã™ã€‚

`grafana`ã‚’ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ç¾PodãŒVolumeã‚’ã¤ã‹ã‚“ã§ã„ã¦æ–°Podã«ã‚¢ã‚¿ãƒƒãƒã§ããªã„äº‹è±¡ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

https://github.com/cloudnativedaysjp/dreamkast-infra/issues/1056

è»¢è¨˜ã—ã¦ãŠãã¾ã™ã€‚Argo CDã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ãŒã€æœ¬é¡Œã§ã¯ãªã„ãŸã‚ã€ã•ã‚‰ã£ã¨æµã—ã¦ã—ã¾ã„ã¾ã™ã€‚

> FailedMount
Unable to attach or mount volumes: unmounted volumes=[storage], unattached volumes=[config dashboards-default storage kube-api-access-7pmf2]: timed out waiting for the condition

> FailedMount
Unable to attach or mount volumes: unmounted volumes=[storage], unattached volumes=[storage kube-api-access-7pmf2 config dashboards-default]: timed out waiting for the condition

> FailedMount
Unable to attach or mount volumes: unmounted volumes=[storage], unattached volumes=[dashboards-default storage kube-api-access-7pmf2 config]: timed out waiting for the condition

> FailedAttachVolume
Multi-Attach error for volume "pvc-86994706-bcae-4bce-897f-13b70b0a59f1" Volume is already used by pod(s) grafana-778f96f899-98mqq

![](https://user-images.githubusercontent.com/4710215/137625985-5ea35134-0c10-4d54-962b-90a65cb8b11e.png)
![](https://user-images.githubusercontent.com/4710215/137625998-e0a3c2d2-7ec2-4914-a6cb-06526afc202d.png)

æ—¢çŸ¥ã®ãƒã‚°ã§ã‚ã‚Šã€Deployment Strategyã‚’`Recreate`ã¨ã™ã‚‹ã‹ã€StatefulSetã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§å›é¿ã§ãã¾ã™ã€‚å¾Œè€…ã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚

https://github.com/grafana/helm-charts/issues/146

### Deploymentã‹ã‚‰StatefulSetã«ç§»è¡Œã—ãŸã‚‰ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãŒæ¶ˆå¤±ã—ãŸ

ã¾ã‚ã€ãã†ã§ã™ã‚ˆã­ã€ã¨ã„ã†è©±ã§ã™ãŒã€StatefulSetç§»è¡Œæ™‚ã«Podã‚‚PersistentVolumeClaimã‚‚æ–°ã—ãä½œã‚‰ã‚ŒãŸãŸã‚ã€æ—§PersistentVolumeã«ä¿å­˜ã•ã‚Œã¦ã„ãŸãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æƒ…å ±ãŒæ¶ˆå¤±ã—ã¾ã—ãŸã€‚

ç¾åœ¨ã¯ã™ã¹ã¦ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ã‚³ãƒ¼ãƒ‰ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚

https://github.com/cloudnativedaysjp/dreamkast-infra/pull/1084

è©³ã—ãèª¿ã¹ã¦ã„ã¾ã›ã‚“ãŒã€èªè¨¼æƒ…å ±ã‚‚PersistentVolumeã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ãªæ°—ãŒã—ã¾ã™ã€‚
CloudNative Daysã§åˆ©ç”¨ã—ã¦ã„ã‚‹Grafanaã¯ã€ç›¸æ–¹ãŒAuth0é€£æºã—ã¦ãã‚Œã¦ã„ãŸã®ã§å½±éŸ¿ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚

### admin-passwordã®SyncãŒã†ã¾ãã„ã‹ãªã„

ç›¸æ–¹ãŒæ ¼é—˜ã—ã¦ã„ãŸéƒ¨åˆ†ã§ã€ç§ã¯ã‚ã¾ã‚ŠæŠŠæ¡ã—ã¦ã„ã¾ã›ã‚“ãŒã€admin-passwordã¾ã‚ã‚Šã®æŒ™å‹•ãŒãŠã‹ã—ãã¦ãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„äº‹è±¡ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚
`kubectl exec`ã—ã¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹å›é¿ç­–ãŒã‚ã‚‹ã‚ˆã†ã§ã™ã€‚
ã“ã¡ã‚‰ã«ã¤ã„ã¦ã‚‚Auth0é€£æºå¾Œã¯å½±éŸ¿ãŒãªã„ãŸã‚ã€è§£æ±ºã‚’ç›®æŒ‡ã—ã¾ã›ã‚“ã§ã—ãŸã€‚

### è‡ªä½œãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åã«åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½¿ãˆãªã„

[å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰](https://grafana.com/grafana/dashboards/)ã‚’åˆ©ç”¨ã™ã‚‹éš›ã€ä»¥ä¸‹ã®`Amazon RDS`ã®ã‚ˆã†ã«ã‚­ãƒ¼ã«åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã—ãŸã€‚

```yaml
dashboards:
  default:
    Amazon RDS:
      gnetId: 11264
      revision: 2
    Amazon EC2:
      gnetId: 11265
      revision: 2
```

è‡ªä½œãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚‚åŒã˜ãƒãƒªã§ã‚„ã‚ã†ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã—ãŸã€‚

```yaml
dashboards:
  default:
    Kubernetes Pod:
      json: |
        {
          "annotations": {
        ...
```

ã—ã‹ã—ã€ã‚¨ãƒ©ãƒ¼ã¨ãªã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚

> ConfigMap "grafana-dashboards-default" is invalid: data[Kubernetes Pod.json]: Invalid value: "Kubernetes Pod.json": a valid config key must consist of alphanumeric characters, '-', '_' or '.' (e.g. 'key.name', or 'KEY_NAME', or 'key-name', regex used for validation is '[-._a-zA-Z0-9]+')

![](https://user-images.githubusercontent.com/4710215/137624534-82f61e12-bf9c-41c2-b4a0-edc50dc99a0a.png)

è‡ªä½œãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®å ´åˆã€ï¼ˆHelm Chartã®values.yamlã®ï¼‰ã‚­ãƒ¼ãŒConfigMapã®ã‚­ãƒ¼ã¨ã—ã¦ä½¿ã‚ã‚Œã¾ã™ã€‚
ã“ã“ã«ã¯åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½¿ãˆãªã‹ã£ãŸãŸã‚`-`ã«ç½®ãæ›ãˆã¾ã—ãŸã€‚

```yaml
dashboards:
  default:
    Kubernetes-Pod:
      json: |
        {
          "annotations": {
        ...
```

## ãŠã‚ã‚Šã«

Grafana Helm Chartå°å…¥æ™‚ã®ãƒãƒã‚Šã©ã“ã‚ã‚’4ã¤ç´¹ä»‹ã—ã¾ã—ãŸã€‚
ä»Šå¾Œã¯é‹ç”¨ã€æ´»ç”¨ã®çŸ¥è¦‹ã‚’è“„ç©ã—ã¦ã„ããŸã„ã§ã™ã€‚2022å¹´3æœˆã«Observability Conferenceã‚„ã‚Šã¾ã™ã®ã§ï¼
