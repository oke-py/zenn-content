---
title: "prometheus-operatorã§Podã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’åé›†ã™ã‚‹"
emoji: "ğŸ“ˆ"
type: "tech"
topics: ["kubernetes", "prometheus"]
published: true
---

## ã¯ã˜ã‚ã«

Podã®CPUä½¿ç”¨ç‡ã‚„ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ã‚’Prometheusã§åé›†ã—ã‚ˆã†ã¨ã—ãŸã¨ã“ã‚ã€é•·ã„é–“ãƒãƒã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚ã‚„ã£ã¨è§£æ±ºã—ãŸã®ã§ã€[prometheus-operator](https://github.com/prometheus-operator/prometheus-operator)ã§åé›†ã™ã‚‹æ–¹æ³•ã‚’è¨˜ã—ã¾ã™ã€‚

## ç’°å¢ƒ

- macOS Big Sur 11.6
- kind v0.11.1
- Kubernetes v1.21.2
- prometheus-operator v0.48.1

## çµè«–

prometheus-operatorã¯`kube-system` namespaceã«`kubelet` serviceã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã¡ã‚‰ã‚’åˆ©ç”¨ã—ã¦`https://kubelet.kube-system:10250/metrics/cadvisor`ã§Podã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—ã§ãã¾ã™ã€‚

ä»Šå›é©ç”¨ã—ãŸãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã¯ã“ã¡ã‚‰ã§ã™ã€‚
https://github.com/cloudnativedaysjp/dreamkast-infra/tree/19be1639a7e356e00561ba6066d8f27b2e17dd9c/manifests/infra/prometheus/base

ç‰¹ã«é–¢ä¿‚æ·±ã„ã®ã¯ã“ã¡ã‚‰ã§ã™ã€‚
```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: cadvisor
  namespace: kube-system
spec:
  endpoints:
  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
    path: "/metrics/cadvisor"
    port: https-metrics
    scheme: https
    tlsConfig:
      insecureSkipVerify: true
  namespaceSelector:
    matchNames:
      - kube-system
  selector:
    matchLabels:
      app.kubernetes.io/name: kubelet
```

## ç´†ä½™æ›²æŠ˜

### node-exporterã¯Nodeã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã—ã‹å…¬é–‹ã—ã¦ã„ãªã„

æœ€ä½é™ã€[prometheus/node-exporter](https://quay.io/repository/prometheus/node-exporter?tag=latest&tab=tags)ã‚’å…¥ã‚Œã‚‹ã“ã¨ãŒè¦ä»¶ã¨ãªã£ã¦ã„ã¾ã—ãŸã€‚ã“ã‚Œã ã‘ã§æ¸ˆã‚ã°ã‚ˆã‹ã£ãŸã®ã§ã™ãŒã€ãã‚“ãªã«ç”˜ãã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚node-expoterã¯ãã®åã®é€šã‚Šã€Nodeã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—ã™ã‚‹ã‚‚ã®ã§ã—ãŸã€‚

https://gist.github.com/oke-py/d402c844076eb7202e8961ae3d15a24f

### metrics-serverã¯Podã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å…¬é–‹ã—ã¦ã„ãªã„

æ¬¡ã¯[metrics-server](https://github.com/kubernetes-sigs/metrics-server)ã‚’èª¿ã¹ã¾ã—ãŸã€‚metrics-serverã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å…¬é–‹ã—ã¦ã„ã‚‹ã ã‘ã§ã—ãŸã€‚
https://gist.github.com/oke-py/ae9f2e1b2b9e0fe2dfa52c4e49b1596a

### cAdvisorã§ã„ã‘ã‚‹ã‚‰ã—ã„

ã“ã“ã¾ã§ã§ä¸€åº¦ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—ã§ç‡ƒãˆå°½ããŸã®ã§ã™ãŒã€ã•ã‚‰ã«èª¿ã¹ã¦ã¿ã‚‹ã¨cAdvisorãŒã‚³ãƒ³ãƒ†ãƒŠã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å…¬é–‹ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸ[^1][^2]ã€‚cAdvisorã¯kubeletãƒã‚¤ãƒŠãƒªã®ä¸€éƒ¨ã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã‚‹ãã†ã§ã™ã€‚ã¤ã¾ã‚Šã€kubeletã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚Œã°ã„ã‘ãã†ã§ã™ã€‚

### prometheus-operatorã«ã‚ˆã‚Škubelet serviceãŒä½œã‚‰ã‚Œã¦ã„ã‚‹

ã‚´ãƒ¼ãƒ«ç›®å‰ã¨æ€ã„ãã‚„ã€prometheus-operatorã«ã¯`PodMonitor`ã¨`ServiceMonitor`ã—ã‹ç”¨æ„ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è‡ªå‰ã§scrape_configã‚’è¨˜è¿°ã™ã‚Œã°ã‚ˆã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ç¾ã—ãã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ï¼ˆé—‡é›²ã«ï¼Ÿï¼‰èª¿ã¹ã¦ã¿ã‚‹ã¨`kube-system` namespaceã«`kubelet` serviceã‚’è¦‹ã¤ã‘ã¾ã—ãŸã€‚

```
$ kubectl -n kube-system get svc kubelet -o yaml 
```
```yaml
apiVersion: v1
kind: Service
metadata:
  creationTimestamp: "2021-09-17T13:01:49Z"
  labels:
    app.kubernetes.io/managed-by: prometheus-operator
    app.kubernetes.io/name: kubelet
    k8s-app: kubelet
  name: kubelet
  namespace: kube-system
  resourceVersion: "6308"
  uid: 97213adf-62c4-4fcc-83cf-03d45ec2ee17
spec:
  clusterIP: None
  clusterIPs:
  - None
  ipFamilies:
  - IPv4
  - IPv6
  ipFamilyPolicy: RequireDualStack
  ports:
  - name: https-metrics
    port: 10250
    protocol: TCP
    targetPort: 10250
  - name: http-metrics
    port: 10255
    protocol: TCP
    targetPort: 10255
  - name: cadvisor
    port: 4194
    protocol: TCP
    targetPort: 4194
  sessionAffinity: None
  type: ClusterIP
status:
  loadBalancer: {}
```

### ã©ã®portã‚’ä½¿ã†ã®ã‹

1. `http-metrics`
2. `cadvisor`
3. `https-metrics`

ã®é †ã«è©¦ã—ã¾ã—ãŸã€‚ç‰¹ã«æ„å‘³ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å¼·ã„ã¦æŒ™ã’ã‚Œã°ã€httpã®æ–¹ãŒæ¥½ãã†ã¨ã„ã†æ€ æ…¢ã§ã™ã€‚ã¨ã“ã‚ãŒã€1ã¨2ã¯ã„ãšã‚Œã‚‚connection refusedã¨ãªã‚Šã¾ã—ãŸã€‚ãã‚Œã‚‰ã—ã„Issue[^3]ã‚’è¦‹ã¤ã‘ã¾ã—ãŸã€‚ã©ã†ã‚„ã‚‰æœ€è¿‘ã®kubeletã¯10255ã¨4194ã§LISTENã—ã¦ã„ãªã•ãã†ã§ã™ã€‚ã¾ãŸã€`/metrics/cadvisor`ã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å…¬é–‹ã—ã¦ã„ã‚‹ã“ã¨ã‚‚ã‚ã‹ã‚Šã¾ã—ãŸã€‚å®Ÿéš›ã«ã¯ã€`/metrics`ã§kubeletã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ã€`/metrics/cadvisor`ã§ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å…¬é–‹ã—ã¦ã„ã¾ã—ãŸã€‚

https://gist.github.com/oke-py/208a2250f4be0e6c3d497098c7399281
https://gist.github.com/oke-py/1acd62fa23b15508da0b0872ce1c3b7c

## ãŠã‚ã‚Šã«

å½“åˆã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã¯é–“ã«åˆã„ã¾ã›ã‚“ã§ã—ãŸãŒã€ãªã‚“ã¨ã‹Podã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ã¨ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ã‚ã¨ã¯Grafanaãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ç”¨æ„ã™ã‚‹ã ã‘ã§ã™ï¼ˆãã£ã¨ï¼‰ã€‚


[^1]: Prometheus ã¨ Grafana ã‚’ä½¿ç”¨ã—ã¦ AWS Fargate ã§ Amazon EKS ã‚’ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹
https://aws.amazon.com/jp/blogs/news/monitoring-amazon-eks-on-aws-fargate-using-prometheus-and-grafana/
[^2]: Kubernetes ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’ Prometheus ã‚’ä½¿ã£ã¦ç›£è¦–ã™ã‚‹
https://qiita.com/kkohtaka/items/59007f0ada56d9f9a8f4
[^3]: https://github.com/prometheus-operator/prometheus-operator/issues/1741